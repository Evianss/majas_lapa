<!DOCTYPE html>
<html lang="lv">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title id="page-title">Stāsta Detaļas - Mana Fanfic Vietne</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            @apply bg-amber-50 text-stone-800;
        }
        body::-webkit-scrollbar {
            display: none;
        }
        body {
            -ms-overflow-style: none;
            scrollbar-width: none;
        }
        /* Star rating specific styles */
        .star-rating .star {
            cursor: pointer;
            transition: color 0.2s ease-in-out;
        }
        .star-rating .star.filled {
            color: #fbbf24; /* Tailwind yellow-400 */
        }
        .star-rating .star.hovered {
            color: #fcd34d; /* Tailwind yellow-300 */
        }
        .star-rating.disabled .star {
            cursor: default;
        }
    </style>
</head>
<body class="min-h-screen flex flex-col">
    <!-- Header Section -->
    <header class="bg-white shadow-sm py-4" style="background-image: url('colour-ge36531a2f_1920.jpg'); background-size: cover; background-position: center;">
        <div class="container mx-auto px-4 flex justify-between items-center flex-wrap">
            <h1 class="text-3xl font-bold text-white">
                <a href="index.html" class="hover:text-orange-200 transition-colors duration-300">Mana Fanfic Vietne</a>
            </h1>
            <div class="flex items-center space-x-4 md:space-x-6 flex-grow md:flex-grow-0 justify-end md:justify-start">
                <div class="relative w-full md:w-auto max-w-xs order-3 md:order-none mt-4 md:mt-0">
                    <input type="text" id="search-input-detail" placeholder="Meklēt stāstus..." class="w-full pl-10 pr-4 py-2 rounded-md border border-stone-300 focus:ring-orange-500 focus:border-orange-500 text-stone-700 bg-stone-100 shadow-sm">
                    <svg class="absolute left-3 top-1/2 -translate-y-1/2 w-5 h-5 text-stone-500" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path></svg>
                </div>
                <button id="mobile-menu-button-detail" class="md:hidden p-2 rounded-md text-white hover:bg-stone-100 focus:outline-none focus:ring-2 focus:ring-orange-500 order-1 md:order-none">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"></path>
                    </svg>
                </button>
                <div class="relative order-2 md:order-none">
                    <button id="user-menu-button-detail" class="flex items-center space-x-2 p-2 rounded-md text-white hover:bg-stone-100 focus:outline-none focus:ring-2 focus:ring-orange-500">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5.121 17.804A13.937 13.937 0 0112 16c2.5 0 4.847.655 6.879 1.804M15 10a3 3 0 11-6 0 3 3 0 016 0zm6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                        <span class="hidden md:inline">Lietotājs</span>
                        <svg class="w-4 h-4 ml-1" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg>
                    </button>
                    <div id="user-menu-dropdown-detail" class="absolute right-0 mt-2 w-48 bg-white rounded-md shadow-lg py-1 z-20 hidden">
                        <a href="user-profile.html" class="block px-4 py-2 text-stone-700 hover:bg-stone-100">Mans Profils</a>
                        <a href="my-stories.html" class="block px-4 py-2 text-stone-700 hover:bg-stone-100">Mani Stāsti</a>
                        <hr class="border-stone-200 my-1">
                        <a href="#" class="block px-4 py-2 text-red-600 hover:bg-red-50">Izrakstīties</a>
                    </div>
                </div>
            </div>

            <nav id="main-nav-detail" class="hidden md:flex flex-col md:flex-row md:items-center w-full md:w-auto mt-6 md:mt-0 order-4 md:order-none">
                <ul class="flex flex-col md:flex-row space-y-2 md:space-y-0 md:space-x-6 text-lg">
                    <li><a href="index.html" class="block px-3 py-2 rounded-md text-white hover:bg-stone-100 hover:text-orange-700 transition-all duration-300">Sākums</a></li>
                    <li><a href="art.html" class="block px-3 py-2 rounded-md text-white hover:bg-stone-100 hover:text-orange-700 transition-all duration-300">Māksla</a></li>
                    <li><a href="archive.html" class="block px-3 py-2 rounded-md text-white hover:bg-stone-100 hover:text-orange-700 transition-all duration-300">Arhīvs</a></li>
                    <li><a href="forum.html" class="block px-3 py-2 rounded-md text-white hover:bg-stone-100 hover:text-orange-700 transition-all duration-300">Forums</a></li>
                    <li><a href="about-us.html" class="block px-3 py-2 rounded-md text-white hover:bg-stone-100 hover:text-orange-700 transition-all duration-300">Par mums</a></li> <!-- UPDATED LINK -->
                    <li><a href="auth.html?mode=login" class="block px-4 py-2 rounded-md bg-orange-700 text-white hover:bg-orange-800 transition-colors duration-300 shadow-md">Pieteikties</a></li>
                    <li><a href="auth.html?mode=register" class="block px-4 py-2 rounded-md border border-orange-700 text-orange-700 hover:bg-orange-50 transition-colors duration-300 shadow-md">Reģistrēties</a></li>
                </ul>
            </nav>
        </div>
    </header>

    <!-- Main Content Area -->
    <main class="flex-grow py-8">
        <div class="container mx-auto px-4 bg-white p-6 rounded-lg shadow-md">
            <h2 id="fanfic-title" class="text-3xl font-semibold text-center text-stone-800 mb-6 pb-2 relative">
                Ielādē...
                <span class="absolute bottom-0 left-1/2 -translate-x-1/2 w-16 h-1 bg-orange-600 rounded-full"></span>
            </h2>
            <div id="story-content-display" class="text-lg text-stone-700 leading-relaxed">
                <p class="text-center text-stone-500">Ielādē stāsta saturu...</p>
            </div>

            <hr class="border-stone-200 my-8">

            <!-- Rating Section -->
            <section class="text-center">
                <h3 class="text-2xl font-semibold text-stone-800 mb-4">Novērtēt Stāstu</h3>
                <div class="flex items-center justify-center mb-4">
                    <span class="text-xl font-medium text-stone-700 mr-2">Vidējais vērtējums:</span>
                    <div class="flex text-yellow-500 text-2xl" id="average-rating-display">
                        <!-- Placeholder for average stars -->
                        <span class="star">☆</span><span class="star">☆</span><span class="star">☆</span><span class="star">☆</span><span class="star">☆</span>
                        <span class="ml-2 text-stone-600 text-base">(0.0/5)</span>
                    </div>
                </div>

                <div id="rating-section" class="mb-6">
                    <p id="rating-message" class="text-stone-600 mb-4"></p>
                    <div id="star-rating-container" class="star-rating flex justify-center space-x-1 text-4xl text-gray-400">
                        <span class="star" data-value="1">&#9733;</span>
                        <span class="star" data-value="2">&#9733;</span>
                        <span class="star" data-value="3">&#9733;</span>
                        <span class="star" data-value="4">&#9733;</span>
                        <span class="star" data-value="5">&#9733;</span>
                    </div>
                    <p id="rating-status" class="text-sm text-red-500 mt-2 hidden">Lūdzu, piesakieties, lai novērtētu stāstu.</p>
                </div>
            </section>

            <p class="mb-4 text-center">
                <a href="archive.html" class="inline-block px-4 py-2 rounded-md bg-orange-700 text-white hover:bg-orange-800 transition-colors duration-300 shadow-md">Atpakaļ uz visiem fanfikiem</a>
            </p>
        </div>
    </main>

    <!-- Footer Section -->
    <footer class="bg-stone-900 text-white py-6 mt-8">
        <div class="container mx-auto px-4 flex flex-col md:flex-row justify-between items-center text-center md:text-left">
            <p class="mb-4 md:mb-0">&copy; 2025 Mana Fanfic Vietne. Visas tiesības aizsargātas.</p>
            <ul class="flex flex-wrap justify-center space-x-4 md:space-x-6 text-sm">
                <li><a href="privacy-policy.html" class="hover:text-orange-300 transition-colors duration-300">Konfidencialitātes politika</a></li>
                <li><a href="terms-of-service.html" class="hover:text-orange-300 transition-colors duration-300">Lietošanas noteikumi</a></li>
                <li><a href="contact.html" class="hover:text-orange-300 transition-colors duration-300">Kontakti</a></li>
            </ul>
        </div>
    </footer>

    <!-- Firebase SDKs and Initialization -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, addDoc, setDoc, updateDoc, deleteDoc, onSnapshot, collection, query, where, getDocs } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Global variables for Firebase instances and user ID
        let app;
        let db;
        let auth;
        let userId = null;
        let isAuthReady = false; // Flag to indicate if auth state is resolved

        // This function will be called after Firebase is initialized and auth state is resolved
        window.initializePageContent = async function() {
            // --- Dynamic Story Content Loading ---
            const urlParams = new URLSearchParams(window.location.search);
            const storyId = urlParams.get('id');

            const pageTitle = document.getElementById('page-title');
            const fanficTitleElement = document.getElementById('fanfic-title');
            const storyContentDisplay = document.getElementById('story-content-display');

            async function loadStoryContent(id) {
                if (!db || !isAuthReady || !pageTitle || !fanficTitleElement || !storyContentDisplay) {
                    console.warn("Database, auth state, or story display elements not ready for loading story content.");
                    storyContentDisplay.innerHTML = `<p class="text-center text-red-500">Kļūda: Datubāze nav gatava.</p>`;
                    return;
                }

                const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
                const storyRef = doc(db, `artifacts/${appId}/public/data/stories`, id);

                onSnapshot(storyRef, (docSnap) => {
                    if (docSnap.exists()) {
                        const story = docSnap.data();
                        pageTitle.textContent = `${story.title} - Mana Fanfic Vietne`;
                        fanficTitleElement.textContent = story.title;
                        storyContentDisplay.innerHTML = `
                            <p class="mb-4">${story.content ? story.content.replace(/\n/g, '<br>') : 'Nav pieejams stāsta saturs.'}</p>
                            <p class="mb-4">Stāsta autors: <span class="font-medium text-orange-700">${story.author || 'Nezināms'}</span></p>
                            <p class="mb-4">Žanrs: <span class="font-medium text-orange-700">${story.genre || 'Nav norādīts'}</span></p>
                            <p class="mb-4">Vārdu skaits: <span class="font-medium text-orange-700">${story.wordCount ? story.wordCount.toLocaleString() : 'Nav norādīts'}</span></p>
                            <p class="mb-4">Kopsavilkums: <span class="text-stone-600">${story.summary || 'Nav pieejams kopsavilkums.'}</span></p>
                        `;
                        updateRatingDisplay(story.averageRating, story.totalRatings);
                        initializeRatingSystem(story); // Re-initialize rating system with new story data
                    } else {
                        pageTitle.textContent = "Stāsts Nav Atrasts - Mana Fanfic Vietne";
                        fanficTitleElement.textContent = "Stāsts Nav Atrasts";
                        storyContentDisplay.innerHTML = `<p class="text-center text-red-500">Atvainojiet, stāsts ar ID "${id}" netika atrasts.</p>`;
                        console.error("No such document!");
                    }
                }, (error) => {
                    console.error("Error fetching story:", error);
                    storyContentDisplay.innerHTML = `<p class="text-center text-red-500">Kļūda ielādējot stāstu: ${error.message}</p>`;
                });
            }

            if (storyId) {
                loadStoryContent(storyId);
            } else {
                pageTitle.textContent = "Kļūda - Mana Fanfic Vietne";
                fanficTitleElement.textContent = "Kļūda: Nav norādīts stāsta ID";
                storyContentDisplay.innerHTML = `<p class="text-center text-red-500">Lūdzu, norādiet stāsta ID URL adresē (piemēram, ?id=stasta_id).</p>`;
            }

            // --- Rating Functionality ---
            const starRatingContainer = document.getElementById('star-rating-container');
            const stars = starRatingContainer ? starRatingContainer.querySelectorAll('.star') : [];
            const ratingMessage = document.getElementById('rating-message');
            const ratingStatus = document.getElementById('rating-status');
            const averageRatingDisplay = document.getElementById('average-rating-display');

            let currentStoryData = null; // To hold the current story's data for rating

            function updateRatingDisplay(averageRating, totalRatings) {
                if (!averageRatingDisplay) {
                    console.warn("Average rating display element not found.");
                    return;
                }
                let starHtml = '';
                const roundedAvg = Math.round(averageRating);
                for (let i = 1; i <= 5; i++) {
                    starHtml += `<span class="star ${i <= roundedAvg ? 'filled' : ''}">★</span>`;
                }
                const ratingText = totalRatings > 0 ? `(${averageRating.toFixed(1)}/5, ${totalRatings} vērtējumi)` : '(Nav vērtējumu)';
                averageRatingDisplay.innerHTML = `${starHtml}<span class="ml-2 text-stone-600 text-base">${ratingText}</span>`;
            }

            function updateStarVisuals(rating) {
                if (!starRatingContainer) {
                    console.warn("Star rating container not found for visual update.");
                    return;
                }
                stars.forEach(star => {
                    const starValue = parseInt(star.dataset.value);
                    if (starValue <= rating) {
                        star.classList.add('filled');
                    } else {
                        star.classList.remove('filled');
                    }
                });
            }

            function initializeRatingSystem(story) {
                currentStoryData = story;
                const userHasRated = currentStoryData.ratings && currentStoryData.ratings[userId];

                if (!starRatingContainer || !ratingStatus || !ratingMessage) {
                    console.warn("Rating system elements not found. Cannot initialize rating system.");
                    return;
                }

                if (isAuthReady && userId) { // Check if Firebase auth and user ID are ready
                    ratingStatus.classList.add('hidden'); // Hide login prompt
                    starRatingContainer.classList.remove('disabled');

                    // Update user's previous rating if exists
                    if (userHasRated) {
                        updateStarVisuals(userHasRated);
                        ratingMessage.textContent = `Jūsu vērtējums: ${userHasRated} zvaigznes.`;
                    } else {
                        updateStarVisuals(0); // Reset stars if user hasn't rated
                        ratingMessage.textContent = 'Novērtējiet šo stāstu!';
                    }

                    // Add hover effect
                    starRatingContainer.onmouseover = (event) => {
                        if (event.target.classList.contains('star')) {
                            const hoverValue = parseInt(event.target.dataset.value);
                            stars.forEach(star => {
                                const starValue = parseInt(star.dataset.value);
                                if (starValue <= hoverValue) {
                                    star.classList.add('hovered');
                                } else {
                                    star.classList.remove('hovered');
                                }
                            });
                        }
                    };

                    starRatingContainer.onmouseout = () => {
                        stars.forEach(star => star.classList.remove('hovered'));
                        updateStarVisuals(userHasRated || 0); // Revert to user's actual rating or 0
                    };

                    // Handle click to set rating
                    starRatingContainer.onclick = async (event) => {
                        if (event.target.classList.contains('star')) {
                            const newRating = parseInt(event.target.dataset.value);
                            if (!db || !userId) {
                                console.error("Firestore or user not ready to submit rating.");
                                return;
                            }

                            const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
                            const storyRef = doc(db, `artifacts/${appId}/public/data/stories`, storyId);

                            try {
                                // Get current story data to update ratings
                                const currentStorySnap = await getDoc(storyRef);
                                if (currentStorySnap.exists()) {
                                    const currentData = currentStorySnap.data();
                                    const existingRatings = currentData.ratings || {};
                                    let currentTotalRatings = currentData.totalRatings || 0;
                                    let currentSumRatings = (currentData.averageRating || 0) * currentTotalRatings;

                                    if (existingRatings[userId]) {
                                        // User is changing their rating
                                        currentSumRatings -= existingRatings[userId]; // Subtract old rating
                                        currentSumRatings += newRating; // Add new rating
                                    } else {
                                        // New rating from this user
                                        currentSumRatings += newRating;
                                        currentTotalRatings++;
                                    }

                                    const newAverageRating = currentTotalRatings > 0 ? currentSumRatings / currentTotalRatings : 0;

                                    existingRatings[userId] = newRating; // Update user's specific rating

                                    await updateDoc(storyRef, {
                                        averageRating: newAverageRating,
                                        totalRatings: currentTotalRatings,
                                        ratings: existingRatings // Save the updated map
                                    });

                                    ratingMessage.textContent = `Paldies par jūsu novērtējumu: ${newRating} zvaigznes!`;
                                    updateStarVisuals(newRating); // Update local visuals immediately
                                    updateRatingDisplay(newAverageRating, currentTotalRatings); // Update average display
                                }
                            } catch (e) {
                                console.error("Error updating rating:", e);
                                ratingMessage.textContent = "Kļūda saglabājot vērtējumu.";
                            }
                        }
                    };
                } else {
                    // Disable rating for unregistered users
                    starRatingContainer.classList.add('disabled');
                    ratingStatus.classList.remove('hidden'); // Show login prompt
                    stars.forEach(star => star.style.color = '#d1d5db'); // Make stars grey
                    ratingMessage.textContent = ''; // Clear message
                }
            }

            // Call initializeRatingSystem when page content is loaded
            // This is handled by loadStoryContent which calls initializeRatingSystem(story)
        };

        // Initialize Firebase and authenticate
        document.addEventListener('DOMContentLoaded', async () => {
            try {
                const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
                const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {};

                if (Object.keys(firebaseConfig).length === 0) {
                    console.error("Firebase configuration is missing. Please provide __firebase_config.");
                    return;
                }

                app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);

                // Mobile Menu Toggle
                const mobileMenuButton = document.getElementById('mobile-menu-button-detail');
                const mainNav = document.getElementById('main-nav-detail');
                if (mobileMenuButton && mainNav) {
                    mobileMenuButton.addEventListener('click', function() {
                        mainNav.classList.toggle('hidden');
                        mainNav.classList.toggle('flex');
                        mainNav.classList.toggle('flex-col');
                    });
                    mainNav.querySelectorAll('a').forEach(link => {
                        link.addEventListener('click', () => {
                            if (window.innerWidth < 768) {
                                mainNav.classList.add('hidden');
                                mainNav.classList.remove('flex');
                                mainNav.classList.remove('flex-col');
                            }
                        });
                    });
                    window.addEventListener('resize', () => {
                        if (window.innerWidth >= 768) {
                            mainNav.classList.remove('hidden');
                            mainNav.classList.add('flex');
                            mainNav.classList.remove('flex-col');
                        } else {
                            mainNav.classList.add('hidden');
                            mainNav.classList.remove('flex');
                            mainNav.classList.remove('flex-col');
                        }
                    });
                } else {
                    console.warn("Mobile menu elements not found on DOMContentLoaded.");
                }

                // User Profile Dropdown
                const userMenuButton = document.getElementById('user-menu-button-detail');
                const userMenuDropdown = document.getElementById('user-menu-dropdown-detail');
                if (userMenuButton && userMenuDropdown) {
                    userMenuButton.addEventListener('click', function(event) {
                        event.stopPropagation();
                        userMenuDropdown.classList.toggle('hidden');
                    });
                    document.addEventListener('click', function(event) {
                        if (!userMenuButton.contains(event.target) && !userMenuDropdown.contains(event.target)) {
                            userMenuDropdown.classList.add('hidden');
                        }
                    });
                } else {
                    console.warn("User menu elements not found on DOMContentLoaded.");
                }

                onAuthStateChanged(auth, async (user) => {
                    if (user) {
                        userId = user.uid;
                        console.log("Authenticated with Firebase UID:", userId);
                    } else {
                        // Sign in anonymously if no user is logged in
                        try {
                            const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null; // Get initialAuthToken here
                            if (initialAuthToken) {
                                await signInWithCustomToken(auth, initialAuthToken);
                                userId = auth.currentUser.uid;
                                console.log("Signed in with custom token. UID:", userId);
                            } else {
                                await signInAnonymously(auth);
                                userId = auth.currentUser.uid;
                                console.log("Signed in anonymously. UID:", userId);
                            }
                        } catch (error) {
                            console.error("Firebase authentication error:", error);
                        }
                    }
                    isAuthReady = true; // Auth state is resolved
                    initializePageContent(); // Call content initialization after auth is ready
                });

            } catch (error) {
                console.error("Failed to initialize Firebase:", error);
            }
        });
    </script>
</body>
</html>
